<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Initial Sound Match â€” Aâ€“Z (Emoji/SVG) â€” Upgraded</title>
<style>
  /* ================================
     Theme tokens
  =================================*/
  :root{
    --ink:#111827;
    --muted:#6b7280;
    --panel:#ffffff;
    --line:#d1d5db;
    --brand:#007aff;
    --good:#34c759;
    --bad:#ff3b30;
    --bg:#ffffff;
    --shadow:0 2px 6px rgba(0,0,0,.08);
    --radius:14px;
    --edge-size:18px;
    --teacher-min:220px;
    --teacher-max:640px;
    --teacher-default:28rem;
  }

  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    /* Primary-school-friendly font stack with single-storey â€œaâ€ where available */
    font-family:"Sassoon Primary", Andika, "Chalkboard SE", "Comic Sans MS", "Segoe Print", "Arial Rounded MT Bold", system-ui, -apple-system, Arial, sans-serif;
    -webkit-font-smoothing:antialiased;
    overflow:hidden;
    touch-action:manipulation;
  }

  /* ================================
     Layout with collapsible + resizable setup panel
  =================================*/
  .app{
    height:100vh;
    display:flex;
    position:relative;
  }

  aside.teacher{
    width:var(--teacher-default);
    max-width:35vw;
    min-width:var(--teacher-min);
    border-right:1px solid var(--line);
    background:var(--panel);
    padding:16px;
    overflow:auto;
    transition: transform .35s ease, width .35s ease, min-width .35s ease, padding .35s ease;
    z-index:2;
    transform: translateX(0);
  }

  /* resizer/dragbar between panels */
  .dragbar{
    width:6px;
    cursor:col-resize;
    background:linear-gradient(90deg, transparent 0%, rgba(0,0,0,.06) 50%, transparent 100%);
    position:relative;
    z-index:3;
    transition: width .35s ease;
  }
  .dragbar:after{
    content:"";
    position:absolute; inset:0;
    background:repeating-linear-gradient( to bottom, rgba(0,0,0,.12), rgba(0,0,0,.12) 1px, transparent 1px, transparent 4px);
    opacity:.25;
    pointer-events:none;
  }

  main.student{
    flex:1;
    background:#fff;
    padding:20px;
    overflow:auto;
    position:relative;
    z-index:1;
  }

  /* Slide-hide behaviour */
  .edge-tab{
    position:absolute;
    left:0; top:50%;
    transform:translate(-50%,-50%);
    background:var(--brand);
    color:#fff;
    padding:8px 10px;
    border-radius:10px;
    font-weight:700;
    box-shadow:var(--shadow);
    writing-mode:vertical-rl;
    text-orientation:mixed;
    cursor:pointer;
    z-index:4;
    transition:opacity .25s ease, transform .35s ease;
  }
  .edge-tab:focus{ outline:2px solid #000; outline-offset:2px; }

  .app.collapsed aside.teacher{
    width:0;
    min-width:0;
    padding:0;
    border:0;
    transform:translateX(-100%);
    overflow:hidden;
  }
  .app.collapsed .dragbar{
    width:0;
    pointer-events:none;
    opacity:.2;
  }
  .app.collapsed .edge-tab{
    transform:translate(-30%,-50%);
  }

  /* Headering & controls */
  h1{ font-size:clamp(22px,2.4vw,40px); margin:0 0 10px; text-align:center; }
  h2{ font-size:16px; margin:18px 0 8px; }
  label{ font-size:14px; color:#111827; display:block; margin-bottom:4px; }
  select, input[type="number"], input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
    font-size:14px; background:#fff;
  }
  .btn{
    width:100%; padding:12px 14px; border:none; border-radius:10px; color:#fff; font-weight:700; cursor:pointer;
    box-shadow:var(--shadow); transition:transform .06s ease;
  }
  .btn:active{ transform:translateY(1px) }
  .btn-primary{ background:var(--brand) }
  .btn-worksheet{ background:#34c759 }
  .btn-export{ background:#ff9500 }
  .btn-clear{ background:#6b7280 }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .toolbar{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px; }
  .muted{ color:var(--muted); font-size:13px; }
  .divider{ height:1px; background:var(--line); margin:14px 0; }

  /* Workspace */
  .target-area{ margin:12px auto 8px; max-width:760px; display:grid; grid-template-columns:1fr; gap:12px; place-items:center; }
  .flashcard{ width:160px; height:160px; border:1px solid var(--line); border-radius:12px; display:grid; place-items:center; font-size:80px; background:#fff; box-shadow:var(--shadow); user-select:none; touch-action:none; }
  .letter{ font-size:70px; font-weight:900; }
  .dropzone{
    width:300px; height:100px; border:2px dashed #c7c7cc; border-radius:16px; display:grid; place-items:center;
    color:var(--muted); font-size:18px; background:#fff; text-align:center;
  }
  .dropzone.good{ background:#e6ffed; border-color:var(--good); }
  .dropzone.bad{ background:#ffebee; border-color:var(--bad); }
  .statusline{ font-size:14px; color:var(--muted); margin-top:6px; text-align:center; }

  .picture-grid{ display:grid; grid-template-columns:repeat(3, minmax(220px, 1fr)); gap:18px; align-items:stretch; margin:16px auto 0; max-width:1000px; }
  .card{ border:1px solid var(--line); border-radius:var(--radius); background:#fff; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:260px; }
  .card .imgbox{ flex:1; display:grid; place-items:center; background:#f8fafc; position:relative; }
  .emoji{ font-size:120px; line-height:1; filter:drop-shadow(0 1px 0 rgba(0,0,0,.06)); user-select:none; }
  .fallback svg{ width:90%; height:90%; display:block; }
  .card .label{ padding:10px 12px; border-top:1px solid var(--line); font-size:20px; text-align:center; background:#fff; user-select:none; }
  .draggable{ cursor:grab }
  .draggable:active{ cursor:grabbing }

  /* NEW: Speaker button for text-to-speech */
  .speaker-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.8);
    border: 1px solid var(--line);
    border-radius: 50%;
    display: grid;
    place-items: center;
    font-size: 20px;
    cursor: pointer;
    backdrop-filter: blur(2px);
    transition: background .2s ease, transform .1s ease;
    z-index: 10;
    -webkit-appearance: none;
    appearance: none;
    padding: 0;
  }
  .speaker-btn:hover { background: rgba(255, 255, 255, 1); }
  .speaker-btn:active { transform: scale(0.9); }


  @keyframes shake{
    0%,100%{ transform:translateX(0) }
    20%{ transform:translateX(-6px) }
    40%{ transform:translateX(6px) }
    60%{ transform:translateX(-4px) }
    80%{ transform:translateX(4px) }
  }
  .shake{ animation:shake .35s }

  .overlay{ position:absolute; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50; }
  .sheet{ width:min(680px,92vw); background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); padding:20px; }
  .sheet h3{ margin:0 0 10px; font-size:22px }
  .summary-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px }

  /* Toggle button inside panel header */
  .panel-actions{
    margin-bottom:10px;
  }

  /* Make tab only visible when collapsed, but keep it clickable at all times near the left edge */
  .edge-tab{ opacity:0; pointer-events:none; }
  .app.collapsed .edge-tab{ opacity:1; pointer-events:auto; }

  /* Better touch targets on small screens */
  @media (max-width:900px){
    .picture-grid{ grid-template-columns:repeat(2, minmax(160px,1fr)); gap:12px; }
    aside.teacher{ max-width:85vw; }
  }

  /* NEW: Toggle Switch Styles */
  .toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 20px; /* Aligns with other inputs */
  }
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
  }
  input:checked + .slider {
    background-color: var(--good); /* Use theme green color */
  }
  input:focus + .slider {
    box-shadow: 0 0 1px var(--good);
  }
  input:checked + .slider:before {
    -webkit-transform: translateX(22px);
    -ms-transform: translateX(22px);
    transform: translateX(22px);
  }
  .slider.round {
    border-radius: 28px;
  }
  .slider.round:before {
    border-radius: 50%;
  }

  /* Student Insight Banner */
  .insight-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    animation: slideIn 0.3s ease;
  }
  
  .insight-banner strong {
    display: block;
    font-size: 13px;
    margin-bottom: 6px;
    opacity: 0.9;
  }
  
  .insight-banner .insight-content {
    font-size: 14px;
    line-height: 1.5;
  }
  
  .insight-banner .stat {
    display: inline-block;
    margin-right: 12px;
    margin-top: 4px;
  }
  
  .insight-banner .struggling {
    color: #ffeb3b;
    font-weight: 700;
  }
  
  .insight-banner .mastered {
    color: #4caf50;
    font-weight: 700;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Progress Dashboard */
  .dashboard-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
  }
  
  .dashboard-overlay.active {
    display: flex;
  }
  
  .dashboard-sheet {
    width: min(920px, 95vw);
    max-height: 90vh;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px 28px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .dashboard-header h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }
  
  .dashboard-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    display: grid;
    place-items: center;
    transition: all 0.2s;
  }
  
  .dashboard-close:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
  }
  
  .dashboard-content {
    padding: 28px;
    overflow-y: auto;
    flex: 1;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
  }
  
  .stat-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 14px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
  }
  
  .stat-value {
    font-size: 36px;
    font-weight: 800;
    color: #2c3e50;
    line-height: 1;
    margin-bottom: 8px;
  }
  
  .stat-label {
    font-size: 13px;
    color: #5a6c7d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .dashboard-section {
    margin-bottom: 28px;
  }
  
  .dashboard-section h4 {
    font-size: 18px;
    color: #2c3e50;
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .sound-mastery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
    gap: 10px;
    margin-bottom: 12px;
  }
  
  .sound-cell {
    aspect-ratio: 1;
    border-radius: 10px;
    display: grid;
    place-items: center;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  
  .sound-cell:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }
  
  .sound-cell.untested {
    background: #e0e0e0;
    color: #9e9e9e;
  }
  
  .sound-cell.struggling {
    background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
    color: white;
  }
  
  .sound-cell.practicing {
    background: linear-gradient(135deg, #ffd93d, #ffb800);
    color: #333;
  }
  
  .sound-cell.mastered {
    background: linear-gradient(135deg, #6bcf7f, #4caf50);
    color: white;
  }
  
  .sound-cell .sound-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
    margin-bottom: 4px;
  }
  
  .sound-cell:hover .sound-tooltip {
    opacity: 1;
  }
  
  .mastery-legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    font-size: 13px;
    color: #666;
    margin-top: 12px;
  }
  
  .mastery-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
  }
  
  .session-timeline {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .session-item {
    background: #f8f9fa;
    border-left: 4px solid var(--brand);
    padding: 14px 18px;
    border-radius: 8px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 16px;
    align-items: center;
  }
  
  .session-date {
    font-size: 12px;
    color: #666;
    min-width: 100px;
  }
  
  .session-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  
  .session-target {
    font-size: 16px;
    font-weight: 700;
    color: #2c3e50;
  }
  
  .session-score {
    font-size: 14px;
    color: #666;
  }
  
  .session-trend {
    font-size: 20px;
  }
  
  .dashboard-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
  }
  
  @media (max-width: 700px) {
    .dashboard-sheet {
      width: 100%;
      max-height: 100vh;
      border-radius: 0;
    }
    
    .sound-mastery-grid {
      grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));
      gap: 8px;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }

</style>
</head>
<body>
<div class="app" role="application" aria-label="Initial Sound Matching A-Z" id="app">
  <aside class="teacher" id="teacherPanel" aria-label="Teacher Controls">
    <div class="panel-actions">
      <button class="btn btn-primary" id="hidePanelBtn" aria-controls="teacherPanel" aria-expanded="true" title="Hide setup (Tab to edge label to reopen)">Hide Setup</button>
    </div>
    <h2>Setup</h2>
    <div class="row">
      <div>
        <label for="studentName">Student</label>
        <input id="studentName" type="text" placeholder="e.g., Jake" autocomplete="off" />
      </div>
      <div>
        <label for="targetSound">Target sound</label>
        <select id="targetSound" aria-label="Target sound"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label for="attemptsCount">Attempts per sound</label>
        <input id="attemptsCount" type="number" min="3" max="15" value="10" />
      </div>
      <div>
        <label for="showWordLabels">Word labels</label>
        <select id="showWordLabels">
          <option value="on" selected>On</option>
          <option value="off">Off</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div>
        <label for="imageMode">Image mode</label>
        <select id="imageMode">
          <option value="emoji" selected>Emoji</option>
          <option value="fallback">Fallback SVG</option>
        </select>
      </div>
      <div>
        <label>Image Options (2 or 3)</label>
        <div class="toggle-container">
            <span>2 Images</span>
            <label class="switch">
              <input type="checkbox" id="numChoicesToggle">
              <span class="slider round"></span>
            </label>
            <span>3 Images</span>
        </div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn btn-primary" id="startBtn">Start Session</button>
      <button class="btn btn-worksheet" id="worksheetBtn">Worksheet (Print)</button>
    </div>
    <div class="toolbar">
       <button class="btn btn-export" id="exportBtn">Export Attempts (CSV)</button>
       <button class="btn btn-clear" id="clearBtn">Clear Attempts</button>
    </div>
    <div class="toolbar">
       <button class="btn btn-primary" id="dashboardBtn" style="background:#667eea;">ğŸ“Š View Dashboard</button>
    </div>
    <div class="divider"></div>
    <p class="muted">Select options and press <strong>Start Session</strong>. Drag the correct picture to the box under the letter. The setup panel can be hidden with <em>Hide Setup</em>, dragged narrower/wider with the bar, and reopened using the <em>Setup</em> edge tab.</p>
  </aside>

  <div class="dragbar" id="dragbar" aria-hidden="true"></div>

  <main class="student" aria-live="polite">
    <h1>Initial Sound Match â€” Drag the Picture to the Letter</h1>
    <div class="target-area">
      <div id="flashcard" class="flashcard">
        <span class="letter" id="letter">a</span>
      </div>
      <div id="dropzone" class="dropzone" aria-label="Drop the correct picture here">Drop picture here</div>
      <div id="statusline" class="statusline">Attempts: <span id="attemptNum">0</span>/<span id="attemptTotal">10</span> &nbsp; â€¢ &nbsp; Correct: <span id="correctNum">0</span></div>
    </div>
    <section aria-label="Picture Choices">
      <div id="pictures" class="picture-grid"></div>
    </section>
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
      <div class="sheet">
        <h3 id="summaryTitle">Round complete</h3>
        <p id="summaryText" class="muted"></p>
        <div class="summary-grid">
          <button class="btn btn-primary" id="newRoundBtn">New Round</button>
          <button class="btn btn-worksheet" id="worksheetBtn2">Worksheet (Print)</button>
        </div>
         <div class="summary-grid" style="margin-top:10px;">
          <button class="btn btn-export" id="exportBtn2">Export Attempts (CSV)</button>
          <button class="btn btn-clear" onclick="document.getElementById('overlay').style.display='none'">Close</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Edge tab appears when the panel is collapsed -->
  <div class="edge-tab" id="edgeTab" role="button" aria-controls="teacherPanel" aria-expanded="false" tabindex="0" title="Show setup">Setup</div>
</div>

<!-- Progress Dashboard -->
<div class="dashboard-overlay" id="dashboardOverlay">
  <div class="dashboard-sheet">
    <div class="dashboard-header">
      <h3 id="dashboardTitle">ğŸ“Š Progress Dashboard</h3>
      <button class="dashboard-close" id="dashboardClose" aria-label="Close dashboard">Ã—</button>
    </div>
    <div class="dashboard-content" id="dashboardContent">
      <!-- Dynamic content rendered here -->
    </div>
  </div>
</div>

<script>
  // ---------- Small DOM helpers
  const $ = (s)=>document.querySelector(s);
  const el = (t,props={})=>Object.assign(document.createElement(t),props);

  // ---------- Collapsible + resizable setup panel
  const app = $("#app");
  const teacher = $("#teacherPanel");
  const dragbar = $("#dragbar");
  const hideBtn = $("#hidePanelBtn");
  const edgeTab = $("#edgeTab");

  let isDragging = false;
  let startX = 0;
  let startWidth = 0;

  function setTeacherWidth(px){
    const min = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--teacher-min")) || 220;
    const max = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--teacher-max")) || 640;
    const clamped = Math.max(min, Math.min(max, px));
    teacher.style.width = clamped + "px";
  }

  dragbar.addEventListener("mousedown",(e)=>{
    isDragging = true;
    startX = e.clientX;
    startWidth = teacher.getBoundingClientRect().width;
    document.body.style.userSelect = "none";
  });
  window.addEventListener("mousemove",(e)=>{
    if(!isDragging) return;
    const delta = e.clientX - startX;
    setTeacherWidth(startWidth + delta);
  });
  window.addEventListener("mouseup",()=>{
    if(!isDragging) return;
    isDragging = false;
    document.body.style.userSelect = "";
  });

  function collapsePanel(){
    app.classList.add("collapsed");
    hideBtn.setAttribute("aria-expanded","false");
    edgeTab.setAttribute("aria-expanded","false");
  }
  function expandPanel(){
    app.classList.remove("collapsed");
    hideBtn.setAttribute("aria-expanded","true");
    edgeTab.setAttribute("aria-expanded","true");
  }

  hideBtn.addEventListener("click", ()=>{
    if(app.classList.contains("collapsed")) expandPanel(); else collapsePanel();
  });
  edgeTab.addEventListener("click", expandPanel);
  edgeTab.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"||e.key===" "){ e.preventDefault(); expandPanel(); }
  });

  // ---------- Populate letters
  (function populateLetters(){
    const select = document.getElementById('targetSound');
    const letters = 'abcdefghijklmnopqrstuvwxyz'.split('');
    letters.forEach((l)=>{
      const opt = document.createElement('option');
      opt.value = l; opt.textContent = l;
      if(l==='a') opt.selected = true;
      select.appendChild(opt);
    });
  })();

  // ---------- Word bank
  const BANK = {
    a:[{word:'apple',emoji:'ğŸ'},{word:'ant',emoji:'ğŸœ'},{word:'airplane',emoji:'âœˆï¸'},{word:'alligator',emoji:'ğŸŠ'}],
    b:[{word:'banana',emoji:'ğŸŒ'},{word:'ball',emoji:'ğŸ€'},{word:'bear',emoji:'ğŸ»'},{word:'butterfly',emoji:'ğŸ¦‹'},{word:'bus',emoji:'ğŸšŒ'},{word:'boat',emoji:'ğŸš¤'}],
    c:[{word:'cat',emoji:'ğŸ±'},{word:'car',emoji:'ğŸš—'},{word:'cow',emoji:'ğŸ„'},{word:'cake',emoji:'ğŸ‚'},{word:'camel',emoji:'ğŸª'},{word:'carrot',emoji:'ğŸ¥•'}],
    d:[{word:'dog',emoji:'ğŸ¶'},{word:'duck',emoji:'ğŸ¦†'},{word:'donut',emoji:'ğŸ©'},{word:'drum',emoji:'ğŸ¥'},{word:'dolphin',emoji:'ğŸ¬'},{word:'deer',emoji:'ğŸ¦Œ'}],
    e:[{word:'elephant',emoji:'ğŸ˜'},{word:'egg',emoji:'ğŸ¥š'},{word:'envelope',emoji:'âœ‰ï¸'},{word:'eagle',emoji:'ğŸ¦…'},{word:'earth',emoji:'ğŸŒ'}],
    f:[{word:'fish',emoji:'ğŸŸ'},{word:'frog',emoji:'ğŸ¸'},{word:'fox',emoji:'ğŸ¦Š'},{word:'flower',emoji:'ğŸŒ¸'},{word:'fire',emoji:'ğŸ”¥'}],
    g:[{word:'goat',emoji:'ğŸ'},{word:'grapes',emoji:'ğŸ‡'},{word:'gorilla',emoji:'ğŸ¦'},{word:'guitar',emoji:'ğŸ¸'},{word:'ghost',emoji:'ğŸ‘»'},{word:'gift',emoji:'ğŸ'},{word:'game die',emoji:'ğŸ²'},{word:'globe',emoji:'ğŸŒ'},{word:'girl',emoji:'ğŸ‘§'},{word:'glasses',emoji:'ğŸ‘“'},{word:'goose',emoji:'ğŸª¿'}],
    h:[{word:'horse',emoji:'ğŸ´'},{word:'hat',emoji:'ğŸ©'},{word:'hamburger',emoji:'ğŸ”'},{word:'helicopter',emoji:'ğŸš'},{word:'house',emoji:'ğŸ '},{word:'heart',emoji:'â¤ï¸'},{word:'hippo',emoji:'ğŸ¦›'}],
    i:[{word:'ice cream',emoji:'ğŸ¦'},{word:'iguana',emoji:'ğŸ¦'},{word:'island',emoji:'ğŸï¸'},{word:'insect',emoji:'ğŸ›'},{word:'ink',emoji:'ğŸ–‹ï¸'}],
    j:[{word:'jellyfish',emoji:'ğŸª¼'},{word:'juice',emoji:'ğŸ¥¤'},{word:'jacket',emoji:'ğŸ§¥'},{word:'jar',emoji:'ğŸ«™'},{word:'jet',emoji:'âœˆï¸'}],
    k:[{word:'kangaroo',emoji:'ğŸ¦˜'},{word:'key',emoji:'ğŸ”‘'},{word:'kiwi',emoji:'ğŸ¥'},{word:'kite',emoji:'ğŸª'},{word:'koala',emoji:'ğŸ¨'}],
    l:[{word:'lion',emoji:'ğŸ¦'},{word:'lemon',emoji:'ğŸ‹'},{word:'leaf',emoji:'ğŸƒ'},{word:'lamp',emoji:'ğŸ’¡'},{word:'ladybug',emoji:'ğŸ'},{word:'ladder',emoji:'ğŸªœ'}],
    m:[{word:'monkey',emoji:'ğŸ’'},{word:'mouse',emoji:'ğŸ­'},{word:'mushroom',emoji:'ğŸ„'},{word:'moon',emoji:'ğŸŒ™'},{word:'milk',emoji:'ğŸ¥›'},{word:'mountain',emoji:'ğŸ”ï¸'}],
    n:[{word:'nest',emoji:'ğŸªº'},{word:'notebook',emoji:'ğŸ““'},{word:'nut',emoji:'ğŸ¥œ'},{word:'needle',emoji:'ğŸª¡'},{word:'ninja',emoji:'ğŸ¥·'}],
    o:[{word:'octopus',emoji:'ğŸ™'},{word:'orange',emoji:'ğŸŠ'},{word:'owl',emoji:'ğŸ¦‰'},{word:'ox',emoji:'ğŸ‚'},{word:'ostrich',emoji:'ğŸ¦¤'},{word:'onion',emoji:'ğŸ§…'},{word:'otter',emoji:'ğŸ¦¦'},{word:'olive',emoji:'ğŸ«’'},{word:'ocean',emoji:'ğŸŒŠ'},{word:'oil',emoji:'ğŸ›¢ï¸'},{word:'office',emoji:'ğŸ¢'}],
    p:[{word:'pig',emoji:'ğŸ·'},{word:'panda',emoji:'ğŸ¼'},{word:'pizza',emoji:'ğŸ•'},{word:'penguin',emoji:'ğŸ§'},{word:'pencil',emoji:'âœï¸'},{word:'pumpkin',emoji:'ğŸƒ'},{word:'parrot',emoji:'ğŸ¦œ'},{word:'peach',emoji:'ğŸ‘'},{word:'popcorn',emoji:'ğŸ¿'},{word:'pineapple',emoji:'ğŸ'},{word:'pear',emoji:'ğŸ'},{word:'police car',emoji:'ğŸš“'}],
    q:[{word:'queen',emoji:'ğŸ‘‘'},{word:'quail',emoji:'ğŸ¦ƒ'},{word:'question',emoji:'â“'},{word:'quilt',emoji:'ğŸª¡'}],
    r:[{word:'rabbit',emoji:'ğŸ°'},{word:'rainbow',emoji:'ğŸŒˆ'},{word:'rocket',emoji:'ğŸš€'},{word:'robot',emoji:'ğŸ¤–'},{word:'ring',emoji:'ğŸ’'},{word:'rose',emoji:'ğŸŒ¹'}],
    s:[{word:'snake',emoji:'ğŸ'},{word:'sun',emoji:'â˜€ï¸'},{word:'star',emoji:'â­'},{word:'sheep',emoji:'ğŸ‘'},{word:'strawberry',emoji:'ğŸ“'},{word:'snail',emoji:'ğŸŒ'},{word:'snowman',emoji:'â˜ƒï¸'}],
    t:[{word:'turtle',emoji:'ğŸ¢'},{word:'tiger',emoji:'ğŸ…'},{word:'tree',emoji:'ğŸŒ³'},{word:'train',emoji:'ğŸš‚'},{word:'tomato',emoji:'ğŸ…'},{word:'tent',emoji:'â›º'}],
    u:[{word:'unicorn',emoji:'ğŸ¦„'},{word:'umbrella',emoji:'â˜‚ï¸'},{word:'ufo',emoji:'ğŸ›¸'},{word:'ukulele',emoji:'ğŸ¸'}],
    v:[{word:'violin',emoji:'ğŸ»'},{word:'volcano',emoji:'ğŸŒ‹'},{word:'van',emoji:'ğŸš'},{word:'vegetable',emoji:'ğŸ¥¦'}],
    w:[{word:'whale',emoji:'ğŸ‹'},{word:'watermelon',emoji:'ğŸ‰'},{word:'wolf',emoji:'ğŸº'},{word:'worm',emoji:'ğŸª±'},{word:'window',emoji:'ğŸªŸ'},{word:'watch',emoji:'âŒš'}],
    x:[{word:'xylophone',emoji:'ğŸ¹'},{word:'x-ray',emoji:'ğŸ¦´'},{word:'x',emoji:'âŒ'}],
    y:[{word:'yak',emoji:'ğŸ‚'},{word:'yellow',emoji:'ğŸ’›'},{word:'yarn',emoji:'ğŸ§¶'},{word:'yoyo',emoji:'ğŸª€'},{word:'yacht',emoji:'â›µ'},{word:'yam',emoji:'ğŸ '}],
    z:[{word:'zebra',emoji:'ğŸ¦“'},{word:'zucchini',emoji:'ğŸ¥’'},{word:'zipper',emoji:'ğŸ¤'},{word:'zero',emoji:'0ï¸âƒ£'},{word:'zombie',emoji:'ğŸ§Ÿ'}]
  };

  // ---------- Fallback SVG generator (for image mode "fallback")
  const FALLBACK_SVG = {};
  function getFallbackSVG(letter){
    letter = (letter||"").toLowerCase();
    if(FALLBACK_SVG[letter]) return FALLBACK_SVG[letter];
    const idx = letter.charCodeAt(0)-97;
    const hue = ((idx*137)%360+360)%360;
    const bg = `hsl(${hue},60%,85%)`;
    const textColor = '#111827';
    const svg = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="15" fill="${bg}" /><text x="50" y="65" font-size="60" font-family="Arial, sans-serif" fill="${textColor}" text-anchor="middle">${letter.toUpperCase()}</text></svg>`;
    FALLBACK_SVG[letter] = svg;
    return svg;
  }

  // ---------- Utilities
  function shuffle(array){ for (let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]];} return array; }
  function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)] }
  function sampleWithout(arr, excludeSet, k){ const pool = arr.filter(x=>!excludeSet.has(x.word)); shuffle(pool); return pool.slice(0,k); }

  // ---------- OPENAI TEXT-TO-SPEECH API
  const OPENAI_API_KEY = 'sk_d7f984b23bac44a4ca5d5c8c58b1d5c8c58b1d5739e4197cb1ea98160';

  async function speak(text) {
    console.log('ğŸµ Attempting OpenAI TTS for:', text);

    try {
      console.log('ğŸ“¡ Making API request...');
      const response = await fetch('https://api.openai.com/v1/audio/speech', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${OPENAI_API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'tts-1',
          input: text,
          voice: 'alloy', // Options: alloy, echo, fable, onyx, nova, shimmer
          response_format: 'mp3',
          speed: 1.0
        })
      });

      console.log('ğŸ“¡ Response status:', response.status);

      if (!response.ok) {
        throw new Error(`OpenAI API error: ${response.status} - ${response.statusText}`);
      }

      console.log('ğŸµ Converting response to audio blob...');
      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      const audio = new Audio(audioUrl);

      console.log('â–¶ï¸ Playing audio...');
      // Play the audio
      audio.play();

      // Clean up the URL after playback
      audio.onended = () => {
        console.log('ğŸ§¹ Cleaning up audio URL...');
        URL.revokeObjectURL(audioUrl);
      };

      audio.onerror = (e) => {
        console.error('âŒ Audio playback error:', e);
        URL.revokeObjectURL(audioUrl);
      };

    } catch (error) {
      console.error('âŒ TTS Error:', error);
      console.log('ğŸ”„ Falling back to browser TTS...');

      // Fallback to browser TTS if OpenAI fails
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.onstart = () => console.log('â–¶ï¸ Browser TTS started');
        utterance.onend = () => console.log('ğŸ›‘ Browser TTS ended');
        utterance.onerror = (e) => console.error('âŒ Browser TTS error:', e);

        window.speechSynthesis.speak(utterance);
      } else {
        console.error('âŒ No TTS available');
        alert('Text-to-speech not available.');
      }
    }
  }

  // ---------- PERSISTENT MEMORY SYSTEM
  const PROFILES_KEY = 'soundmatch-profiles';
  
  function createNewProfile(name) {
    return {
      name,
      created: new Date().toISOString(),
      lastSession: null,
      totalAttempts: 0,
      totalSessions: 0,
      sessions: [],
      soundMastery: {}
    };
  }
  
  function getStudentProfile(name) {
    if (!name || name === 'N/A') return null;
    const profiles = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}');
    return profiles[name] || createNewProfile(name);
  }
  
  function updateSoundMastery(profile, sessionData) {
    const target = sessionData.target;
    if (!profile.soundMastery[target]) {
      profile.soundMastery[target] = { attempts: 0, correct: 0, sessions: [] };
    }
    
    const mastery = profile.soundMastery[target];
    mastery.attempts += sessionData.totalAttempts;
    mastery.correct += sessionData.correctCount;
    mastery.accuracy = mastery.correct / mastery.attempts;
    mastery.lastScore = sessionData.accuracy;
    mastery.lastDate = sessionData.date;
    mastery.sessions.push({
      date: sessionData.date,
      score: sessionData.score,
      accuracy: sessionData.accuracy
    });
  }
  
  function saveSession(studentName, sessionData) {
    if (!studentName || studentName === 'N/A') return;
    
    const profiles = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}');
    const profile = profiles[studentName] || createNewProfile(studentName);
    
    profile.sessions.push(sessionData);
    profile.lastSession = sessionData.date;
    profile.totalAttempts += sessionData.totalAttempts;
    profile.totalSessions++;
    
    updateSoundMastery(profile, sessionData);
    
    profiles[studentName] = profile;
    localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
    
    return profile;
  }
  
  function calculateOverallAccuracy(profile) {
    if (!profile || profile.sessions.length === 0) return 0;
    const total = profile.sessions.reduce((sum, s) => sum + s.totalAttempts, 0);
    const correct = profile.sessions.reduce((sum, s) => sum + s.correctCount, 0);
    return total > 0 ? Math.round((correct / total) * 100) : 0;
  }
  
  function getStrugglingLetters(profile, threshold = 0.5, minAttempts = 5) {
    if (!profile || !profile.soundMastery) return [];
    return Object.entries(profile.soundMastery)
      .filter(([sound, data]) => data.accuracy < threshold && data.attempts >= minAttempts)
      .sort((a, b) => a[1].accuracy - b[1].accuracy)
      .map(([sound, data]) => ({ sound, accuracy: data.accuracy, attempts: data.attempts }));
  }
  
  function getMasteredLetters(profile, threshold = 0.7, minAttempts = 5) {
    if (!profile || !profile.soundMastery) return [];
    return Object.entries(profile.soundMastery)
      .filter(([sound, data]) => data.accuracy >= threshold && data.attempts >= minAttempts)
      .map(([sound]) => sound)
      .sort();
  }

  // ---------- State
  let currentTarget='a';
  let totalAttempts=10;
  let attemptIndex=0;
  let correctCount=0;
  let usedTargetWords=new Set();
  let currentCorrectWord=null;
  const attempts=[];
  let currentStudentProfile=null;

  // ---------- Elements
  const studentName = document.getElementById('studentName');
  const targetSoundSel = document.getElementById('targetSound');
  const attemptsCountInput = document.getElementById('attemptsCount');
  const showWordLabels = document.getElementById('showWordLabels');
  const imageModeSel = document.getElementById('imageMode');
  const numChoicesToggle = document.getElementById('numChoicesToggle');
  const letterSpan = document.getElementById('letter');
  const attemptNum = document.getElementById('attemptNum');
  const attemptTotal = document.getElementById('attemptTotal');
  const correctNum = document.getElementById('correctNum');
  const dz = document.getElementById('dropzone');
  const grid = document.getElementById('pictures');
  const overlay = document.getElementById('overlay');
  const summaryText = document.getElementById('summaryText');

  // ---------- Start / new round
  document.getElementById('startBtn').addEventListener('click', ()=>{
    // Auto-hide the setup panel on start for distraction-free student view
    collapsePanel();
    startRound();
  });
  document.getElementById('newRoundBtn').addEventListener('click', startRound);

  function startRound(){
    currentTarget = (targetSoundSel.value||'a').toLowerCase();
    totalAttempts = Math.max(3, Math.min(15, parseInt(attemptsCountInput.value)||10));
    letterSpan.textContent = currentTarget;
    attemptIndex=0; correctCount=0; usedTargetWords = new Set();
    attemptTotal.textContent = totalAttempts; correctNum.textContent='0'; attemptNum.textContent='0';
    overlay.style.display='none';
    dz.textContent='Drop picture here'; dz.className='dropzone';
    nextAttempt();
  }

  function buildChoices(){
    const numChoices = numChoicesToggle.checked ? 3 : 2;
    const numDecoys = numChoices - 1;
    
    const targetBank = BANK[currentTarget];
    const unused = sampleWithout(targetBank, usedTargetWords, 1);
    const chosenCorrect = unused.length ? unused[0] : pickRandom(targetBank);
    currentCorrectWord = chosenCorrect;
    usedTargetWords.add(chosenCorrect.word);
    
    const others = shuffle(Object.keys(BANK).filter(k=>k!==currentTarget));
    const choices = [chosenCorrect];
    
    for(let i = 0; i < numDecoys; i++){
        choices.push(pickRandom(BANK[others[i]]));
    }
    
    return shuffle(choices);
  }

  function renderChoices(cards){
    const numColumns = cards.length;
    grid.style.gridTemplateColumns = `repeat(${numColumns}, minmax(220px, 1fr))`;
    grid.innerHTML='';
    cards.forEach((c)=>{
      const card = el('article',{className:'card', role:'group'});
      const imgbox = el('div',{className:'imgbox draggable', draggable:true});

      // Add speaker button
      const speakerBtn = el('button', {
        className: 'speaker-btn',
        innerHTML: 'ğŸ”Š',
        title: `Hear the word "${c.word}"`,
        'aria-label': `Hear the word "${c.word}"`
      });
      speakerBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent drag-and-drop from starting
        speak(c.word);
      });
      imgbox.appendChild(speakerBtn);

      if(imageModeSel.value==='emoji'){
        const em = el('div',{className:'emoji', textContent:c.emoji, role:'img', 'aria-label':c.word});
        imgbox.appendChild(em);
      }else{
        const first = c.word.toLowerCase().charAt(0);
        const wrapper = el('div',{className:'fallback'});
        wrapper.innerHTML = getFallbackSVG(first);
        imgbox.appendChild(wrapper);
      }
      const label = el('div',{className:'label'});
      label.textContent = c.word;
      if(showWordLabels.value==='off') label.style.visibility='hidden';
      imgbox.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', c.word); });
      card.appendChild(imgbox); card.appendChild(label); grid.appendChild(card);
    });
  }

  function nextAttempt(){
    attemptIndex++; attemptNum.textContent = attemptIndex;
    dz.className='dropzone'; dz.textContent='Drop picture here';
    if(attemptIndex>totalAttempts){ finishRound(); return; }
    renderChoices( buildChoices() );
  }

  dz.addEventListener('dragover', e=>e.preventDefault());
  dz.addEventListener('drop', (e)=>{
    e.preventDefault();
    const word = (e.dataTransfer.getData('text/plain')||'').toLowerCase();
    const ok = !!currentCorrectWord && word === currentCorrectWord.word.toLowerCase();
    feedback(ok, word);
  });

  function feedback(ok, chosenWord){
    dz.classList.toggle('good', ok);
    dz.classList.toggle('bad', !ok);
    dz.textContent = ok ? 'âœ… Correct!' : 'âŒ Try again';
    if(ok){ correctCount++; correctNum.textContent = String(correctCount); confetti(); }
    else { dz.classList.add('shake'); setTimeout(()=>dz.classList.remove('shake'), 350); }
    attempts.push({ time:new Date().toISOString(), student:studentName.value.trim()||'N/A', target:currentTarget, chosenWord, correctWord:currentCorrectWord?.word||'', result: ok?'Correct':'Incorrect' });
    setTimeout(()=>{ if(attemptIndex>=totalAttempts){ finishRound(); } else { nextAttempt(); } }, 800);
  }

  function finishRound(){
    // Save session data to student profile
    const name = studentName.value.trim();
    if (name && name !== 'N/A') {
      const sessionData = {
        date: new Date().toISOString(),
        target: currentTarget,
        attempts: attempts.slice(), // Deep copy
        score: `${correctCount}/${totalAttempts}`,
        totalAttempts: totalAttempts,
        correctCount: correctCount,
        accuracy: correctCount / totalAttempts
      };
      
      currentStudentProfile = saveSession(name, sessionData);
      
      // Show success feedback with historical context
      const profile = currentStudentProfile;
      const soundData = profile.soundMastery[currentTarget];
      const overallAcc = calculateOverallAccuracy(profile);
      
      let contextText = `Target sound "${currentTarget}". Score: ${correctCount} / ${totalAttempts} (${Math.round((correctCount/totalAttempts)*100)}%).`;
      
      if (soundData && soundData.sessions.length > 1) {
        const prevSession = soundData.sessions[soundData.sessions.length - 2];
        const trend = soundData.lastScore > prevSession.accuracy ? 'â†—ï¸ improved' : 
                      soundData.lastScore < prevSession.accuracy ? 'â†˜ï¸ declined' : 'â†’ stable';
        contextText += `\n\nOverall "${currentTarget}" accuracy: ${Math.round(soundData.accuracy * 100)}% (${soundData.attempts} total attempts). Trend: ${trend}.`;
      }
      
      if (profile.totalSessions > 1) {
        contextText += `\n\nOverall performance: ${overallAcc}% across ${profile.totalSessions} sessions.`;
      }
      
      summaryText.textContent = contextText;
    } else {
      summaryText.textContent = `Target sound "${currentTarget}". Score: ${correctCount} / ${totalAttempts}.`;
    }
    
    overlay.style.display='flex';
  }

  function exportCSV(rows){
    if(rows.length === 0){ alert('No attempts to export.'); return; }
    const cols = ['time','student','target','chosenWord','correctWord','result'];
    const csv = [cols.join(',')].concat( rows.map(r=> cols.map(c=> JSON.stringify(r[c]??'')).join(',')) ).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download='initial_sound_attempts.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  }
  document.getElementById('exportBtn').addEventListener('click', ()=>exportCSV(attempts));
  document.getElementById('exportBtn2').addEventListener('click', ()=>exportCSV(attempts));
  document.getElementById('clearBtn').addEventListener('click', ()=>{ attempts.length=0; alert('Attempts cleared.'); });

  function printWorksheet(){
    if(attempts.length === 0){
      alert('No attempts to print on a worksheet.');
      return;
    }
    const student = studentName.value.trim() || 'N/A';
    const date = new Date().toLocaleDateString();
    const win = window.open('', '_blank');

    const tableRows = attempts.map(att => `
      <tr>
        <td>${att.target}</td>
        <td>${att.chosenWord}</td>
        <td>${att.correctWord}</td>
        <td>${att.result === 'Correct' ? 'âœ…' : 'âŒ'}</td>
      </tr>
    `).join('');

    const worksheetHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Initial Sound Match Worksheet</title>
        <style>
          body { font-family: "Sassoon Primary", Andika, "Chalkboard SE", "Comic Sans MS", sans-serif; padding: 20px; }
          h1 { text-align: center; }
          .info { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 18px; }
          table { width: 100%; border-collapse: collapse; font-size: 16px; }
          th, td { border: 1px solid #ccc; padding: 12px; text-align: left; }
          th { background-color: #f2f2f2; }
          td:last-child { font-size: 24px; text-align: center; }
          @media print {
            body { padding: 0; }
            .no-print { display: none; }
          }
        </style>
      </head>
      <body>
        <h1>Initial Sound Match Worksheet</h1>
        <div class="info">
          <span><strong>Student:</strong> ${student}</span>
          <span><strong>Date:</strong> ${date}</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Target Sound</th>
              <th>Chosen Word</th>
              <th>Correct Word</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
        <p class="no-print" style="text-align:center; margin-top:20px;">
          Use your browser's print option (Ctrl/Cmd + P) to print this worksheet or save as a PDF.
        </p>
      </body>
      </html>
    `;
    win.document.write(worksheetHTML);
    win.document.close();
    win.print();
  }
  document.getElementById('worksheetBtn').addEventListener('click', printWorksheet);
  document.getElementById('worksheetBtn2').addEventListener('click', printWorksheet);

  function confetti(){
    for(let i=0;i<60;i++){
      const p=document.createElement('div');
      const size=Math.random()*10+5;
      p.style.cssText=`position:fixed; left:${Math.random()*100}vw; top:${Math.random()*-40}vh; width:${size}px; height:${size}px; background:hsl(${Math.random()*360},100%,60%); opacity:.9; z-index:10000; border-radius:${Math.random()>.5?'50%':'2px'};`;
      document.body.appendChild(p);
      p.animate([{transform:`translateY(0) rotate(${Math.random()*360}deg)`,opacity:1},{transform:`translateY(120vh) rotate(${Math.random()*1000+360}deg)`,opacity:0}],{duration:Math.random()*2200+3400,easing:'cubic-bezier(.1,.6,.4,1)',delay:Math.random()*280,fill:'forwards'});
      setTimeout(()=>p.remove(),6000);
    }
  }

  // ---------- PROGRESS DASHBOARD
  function openDashboard() {
    const name = studentName.value.trim();
    if (!name || name === 'N/A') {
      alert('Please enter a student name first.');
      return;
    }
    
    const profile = getStudentProfile(name);
    if (!profile || profile.totalSessions === 0) {
      alert(`No session data found for ${name}. Complete a session first!`);
      return;
    }
    
    renderDashboard(profile);
    document.getElementById('dashboardOverlay').classList.add('active');
  }
  
  function closeDashboard() {
    document.getElementById('dashboardOverlay').classList.remove('active');
  }
  
  function renderDashboard(profile) {
    const content = document.getElementById('dashboardContent');
    document.getElementById('dashboardTitle').textContent = `ğŸ“Š ${profile.name}'s Progress Dashboard`;
    
    const overallAcc = calculateOverallAccuracy(profile);
    const struggling = getStrugglingLetters(profile);
    const mastered = getMasteredLetters(profile);
    
    // Stats Grid
    let html = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${profile.totalSessions}</div>
          <div class="stat-label">Total Sessions</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${overallAcc}%</div>
          <div class="stat-label">Overall Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${profile.totalAttempts}</div>
          <div class="stat-label">Total Attempts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${mastered.length}/26</div>
          <div class="stat-label">Sounds Mastered</div>
        </div>
      </div>
    `;
    
    // Sound Mastery Heatmap
    html += `
      <div class="dashboard-section">
        <h4>ğŸ¯ Sound Mastery Map</h4>
        <div class="sound-mastery-grid">
          ${renderSoundMasteryGrid(profile)}
        </div>
        <div class="mastery-legend">
          <div class="mastery-legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #6bcf7f, #4caf50);"></div>
            <span>Mastered (â‰¥70%)</span>
          </div>
          <div class="mastery-legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ffd93d, #ffb800);"></div>
            <span>Practicing (50-70%)</span>
          </div>
          <div class="mastery-legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);"></div>
            <span>Needs Help (&lt;50%)</span>
          </div>
          <div class="mastery-legend-item">
            <div class="legend-color" style="background: #e0e0e0;"></div>
            <span>Not Tested</span>
          </div>
        </div>
      </div>
    `;
    
    // Recent Sessions Timeline
    html += `
      <div class="dashboard-section">
        <h4>ğŸ“… Recent Sessions (Last 10)</h4>
        <div class="session-timeline">
          ${renderSessionTimeline(profile)}
        </div>
      </div>
    `;
    
    // Action Buttons
    html += `
      <div class="dashboard-actions">
        <button class="btn btn-export" onclick="exportFullProfileCSV('${profile.name}')">ğŸ“¥ Export Full Report</button>
        <button class="btn btn-clear" onclick="closeDashboard()">Close Dashboard</button>
      </div>
    `;
    
    content.innerHTML = html;
  }
  
  function renderSoundMasteryGrid(profile) {
    const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('');
    
    return alphabet.map(letter => {
      const mastery = profile.soundMastery[letter];
      
      if (!mastery || mastery.attempts === 0) {
        return `<div class="sound-cell untested">${letter}</div>`;
      }
      
      const acc = mastery.accuracy;
      const accPercent = Math.round(acc * 100);
      let className = 'untested';
      
      if (mastery.attempts >= 5) {
        if (acc >= 0.7) className = 'mastered';
        else if (acc >= 0.5) className = 'practicing';
        else className = 'struggling';
      } else {
        className = 'practicing'; // Not enough data yet
      }
      
      return `
        <div class="sound-cell ${className}">
          ${letter}
          <span class="sound-tooltip">${accPercent}% (${mastery.correct}/${mastery.attempts})</span>
        </div>
      `;
    }).join('');
  }
  
  function renderSessionTimeline(profile) {
    const sessions = profile.sessions.slice(-10).reverse(); // Last 10, newest first
    
    if (sessions.length === 0) {
      return '<p class="muted">No sessions yet.</p>';
    }
    
    return sessions.map((session, index) => {
      const date = new Date(session.date).toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      const accPercent = Math.round(session.accuracy * 100);
      
      // Determine trend if not the oldest session
      let trendIcon = '';
      const soundData = profile.soundMastery[session.target];
      if (soundData && soundData.sessions.length > 1) {
        const sessionIndex = soundData.sessions.findIndex(s => s.date === session.date);
        if (sessionIndex > 0) {
          const prevAcc = soundData.sessions[sessionIndex - 1].accuracy;
          if (session.accuracy > prevAcc) trendIcon = 'â†—ï¸';
          else if (session.accuracy < prevAcc) trendIcon = 'â†˜ï¸';
          else trendIcon = 'â†’';
        }
      }
      
      return `
        <div class="session-item">
          <div class="session-date">${date}</div>
          <div class="session-details">
            <div class="session-target">Target: "${session.target}"</div>
            <div class="session-score">Score: ${session.score} (${accPercent}%)</div>
          </div>
          <div class="session-trend">${trendIcon}</div>
        </div>
      `;
    }).join('');
  }
  
  function exportFullProfileCSV(name) {
    const profile = getStudentProfile(name);
    if (!profile || profile.sessions.length === 0) {
      alert('No data to export.');
      return;
    }
    
    const rows = profile.sessions.flatMap(session => 
      session.attempts.map(att => ({
        date: session.date,
        student: name,
        target: session.target,
        sessionScore: session.score,
        time: att.time,
        chosenWord: att.chosenWord,
        correctWord: att.correctWord,
        result: att.result,
        soundAccuracy: profile.soundMastery[session.target]?.accuracy 
          ? Math.round(profile.soundMastery[session.target].accuracy * 100) + '%'
          : 'N/A'
      }))
    );
    
    const cols = ['date', 'student', 'target', 'sessionScore', 'time', 'chosenWord', 'correctWord', 'result', 'soundAccuracy'];
    const csv = [cols.join(',')].concat(
      rows.map(r => cols.map(c => JSON.stringify(r[c] ?? '')).join(','))
    ).join('\n');
    
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${name}_full_progress_report.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
  }

  // ---------- Student Insights Display
  function showStudentInsights(name) {
    // Remove any existing banner
    const existingBanner = document.querySelector('.insight-banner');
    if (existingBanner) existingBanner.remove();
    
    if (!name || name === 'N/A') return;
    
    const profile = getStudentProfile(name);
    if (!profile || profile.totalSessions === 0) return;
    
    const overallAcc = calculateOverallAccuracy(profile);
    const struggling = getStrugglingLetters(profile);
    const mastered = getMasteredLetters(profile);
    
    const banner = document.createElement('div');
    banner.className = 'insight-banner';
    
    let content = `<strong>ğŸ“Š ${name}'s Progress</strong><div class="insight-content">`;
    content += `<div class="stat">Sessions: <strong>${profile.totalSessions}</strong></div>`;
    content += `<div class="stat">Accuracy: <strong>${overallAcc}%</strong></div>`;
    content += `<div class="stat">Total Attempts: <strong>${profile.totalAttempts}</strong></div>`;
    
    if (struggling.length > 0) {
      content += `<div style="margin-top:8px;">`;
      content += `<span class="struggling">âš ï¸ Focus on:</span> `;
      content += struggling.slice(0, 3).map(s => `${s.sound} (${Math.round(s.accuracy * 100)}%)`).join(', ');
      content += `</div>`;
    }
    
    if (mastered.length > 0) {
      content += `<div style="margin-top:4px;">`;
      content += `<span class="mastered">âœ“ Mastered:</span> `;
      content += mastered.slice(0, 10).join(', ');
      if (mastered.length > 10) content += `, +${mastered.length - 10} more`;
      content += `</div>`;
    }
    
    content += `</div>`;
    banner.innerHTML = content;
    
    // Insert after the Setup heading
    const setupHeading = document.querySelector('.teacher h2');
    setupHeading.parentNode.insertBefore(banner, setupHeading.nextSibling);
  }
  
  // Hook up student name input to show insights
  studentName.addEventListener('input', (e) => {
    const name = e.target.value.trim();
    if (name.length >= 2) {
      showStudentInsights(name);
    } else {
      const existingBanner = document.querySelector('.insight-banner');
      if (existingBanner) existingBanner.remove();
    }
  });
  
  // Load insights on page load if name exists
  studentName.addEventListener('blur', (e) => {
    const name = e.target.value.trim();
    if (name) {
      currentStudentProfile = getStudentProfile(name);
      showStudentInsights(name);
    }
  });

  // ---------- Dashboard Event Listeners
  document.getElementById('dashboardBtn').addEventListener('click', openDashboard);
  document.getElementById('dashboardClose').addEventListener('click', closeDashboard);
  
  // Close dashboard when clicking outside
  document.getElementById('dashboardOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'dashboardOverlay') closeDashboard();
  });

  // Autostart so content is visible; do not auto-collapse here (only on Start button)
  (function boot(){
    letterSpan.textContent = 'a';
    attemptTotal.textContent = '10';
    attemptNum.textContent = '0';
    correctNum.textContent = '0';
    renderChoices( (function(){ currentTarget='a'; usedTargetWords=new Set(); currentCorrectWord=null; return buildChoices(); })() );
  })();
</script>
</body>
</html>