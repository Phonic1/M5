<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M5 Sound Matching Board</title>
    <style>
        body {
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            margin: 0;
            background-color: #ffffff;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }

        .watermark {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: #6b7280;
            opacity: 0.7;
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            pointer-events: none;
            z-index: 1000;
        }

        /* M5 Sound Matching Board Styles (adapted from Blending Board) */
        .sound-matching-board { /* Renamed class */
            display: flex;
            height: 100vh;
        }

        .teacher-view {
            width: 20%;
            padding: 15px;
            background-color: #ffffff;
            border-right: 1px solid #d2d2d7;
            max-height: 100vh;
            overflow-y: auto;
        }

        .student-view {
            width: 80%;
            padding: 20px;
            background-color: #ffffff;
            overflow-x: auto;
            box-sizing: border-box;
        }

        .form-group {
            margin: 8px 0;
            font-size: 14px;
        }

        .form-group input {
            width: calc(100% - 18px);
            padding: 8px;
            border: 1px solid #c7c7cc;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            box-sizing: border-box;
            display: block;
            margin-top: 4px;
        }

        .form-group label {
            font-size: 14px;
            color: #1d1d1f;
            display: block;
        }

        .support-dropdown {
            position: relative;
            width: 100%;
        }

        .support-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #c7c7cc;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            background-color: #ffffff;
            appearance: none;
            cursor: pointer;
            box-sizing: border-box;
        }

        .support-select:focus {
            outline: none;
            border-color: #007aff;
        }

        .support-dropdown::after {
            content: 'â–¼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #1d1d1f;
        }

        .support-select option {
            padding: 10px;
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
        }

        @keyframes dropdownFade {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .support-select:focus + .support-options {
            animation: dropdownFade 0.3s ease-in-out;
        }

        .letter-tiles { /* Renamed to sound-tiles in context, but class name kept for CSS consistency */
            min-height: 120px;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 12px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .letter-tile { /* Represents a sound tile */
            display: flex;
            justify-content: center;
            align-items: center;
            width: 160px; /* Fixed width, may need adjustment for very long sounds */
            height: 160px;
            background: #ffffff;
            color: #000000;
            margin: 5px;
            font-size: 60px; /* Slightly reduced for potentially longer sounds */
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            cursor: move;
            user-select: none;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            touch-action: none;
            pointer-events: auto;
            overflow: hidden; /* Prevent text overflow */
            text-overflow: ellipsis; /* Add ellipsis if text is too long */
            white-space: nowrap; /* Keep sound on one line */
            padding: 5px; /* Add some padding */
            box-sizing: border-box;
        }

        .letter-tile.selected {
            border: 2px solid #007aff;
            transform: scale(1.05);
        }

        .drop-zone {
            width: auto; /* Will be set by JS */
            min-width: 200px; /* Enough for one tile */
            height: 200px; /* Enough for one tile */
            border: 2px dashed #c7c7cc;
            margin: 50px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            text-align: center;
            display: flex;
            justify-content: center; /* Center the single tile */
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
            touch-action: none;
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            color: #6b7280;
            font-size: 20px;
        }

        .drop-zone.correct {
            background-color: #e6ffed !important;
            border-color: #34c759 !important;
        }

        .drop-zone.incorrect {
            background-color: #ffebee !important;
            border-color: #ff3b30 !important;
        }

        .smb-button { /* Renamed class */
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
        }

        .smb-button:hover {
            transform: translateY(-1px);
        }

        #generateBtnSMB { background-color: #007aff; color: white; }
        #resetBtnSMB { background-color: #af52de; color: white; }
        #correctBtnSMB { background-color: #34c759; color: white; }
        #incorrectBtnSMB { background-color: #ff3b30; color: white; }
        #reportBtnSMB { background-color: #ff9500; color: white; }
        #printBtnSMB { background-color: #ff2d55; color: white; }
        #resetSessionDataBtnSMB { background-color: #dc3545; color: white; }
        #adminDownloadAllDataBtnSMB { background-color: #17a2b8; color: white; }
        #homeBtnSMB { background-color: #6c757d; color: white; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); overflow-y: auto; }
        .modal-content { background-color: #ffffff; margin: 5% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 800px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif; }
        .close-btn { color: #6b7280; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #000000; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif; }
        .report-table th, .report-table td { border: 1px solid #d2d2d7; padding: 12px; text-align: left; }
        .report-table th { background-color: #f5f5f7; font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .modal-content .report-table th { top: -20px; }
        .report-table tr:nth-child(even) { background-color: #f5f5f7; }
        .report-table tr:hover { background-color: #e9e9eb; }
        .report-status-correct { color: #34c759; font-weight: bold; }
        .report-status-incorrect { color: #ff3b30; font-weight: bold; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .report-controls { display: flex; gap: 10px; margin-top: 20px; }
        .report-btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; transition: background-color 0.3s; font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif; }
        .export-csv-btn { background-color: #007aff; color: white; }
        .print-report-btn { background-color: #6b7280; color: white; }
        .copy-report-btn { background-color: #28a745; color: white; }
        .no-data-message { text-align: center; padding: 40px 0; color: #6b7280; font-size: 18px; }
        .formatted-date { white-space: nowrap; }
        h1 { color: #000000; text-align: center; font-size: 48px; font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif; }
        .student-view > h1 { margin-top: 0; margin-bottom: 20px; }
        h2 { font-size: 18px; color: #1d1d1f; font-family: 'Sassoon Primary', 'Comic Sans MS', Arial, sans-serif; }

        /* Responsive Styles */
        @media (max-width: 1200px) { .drop-zone { min-width: 180px; height: 180px; } .letter-tile { width: 120px; height: 120px; font-size: 48px; } }
        @media (max-width: 768px) { .teacher-view { width: 30%; } .student-view { width: 70%; } .drop-zone { min-width: 150px; height: 150px; } .letter-tile { width: 100px; height: 100px; font-size: 40px; } .modal-content { width: 90%; } }
        @media (max-width: 480px) { .sound-matching-board { flex-direction: column; } .teacher-view { width: 100%; max-height: 50vh; border-right: none; border-bottom: 1px solid #d2d2d7; } .student-view { width: 100%; height: 50vh; } .student-view > h1 { font-size: 24px; } .drop-zone { min-width: 120px; height: 120px; margin: 20px auto; } .letter-tile { width: 80px; height: 80px; font-size: 32px; } .modal-content { width: 95%; margin: 2% auto; } }
        @media print { body { overflow: visible !important; height: auto !important; } body * { visibility: hidden; } #reportModal, #reportModal .modal-content, #reportModal .modal-content * { visibility: visible; } #reportModal { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; height: auto !important; overflow: visible !important; background-color: white !important; z-index: 9999 !important; } .modal-content { position: static !important; width: 100% !important; max-width: none !important; margin: 0 !important; padding: 10px !important; border: none !important; box-shadow: none !important; max-height: none !important; overflow-y: visible !important; } .report-header { margin-bottom: 15px; } .report-header h2 { font-size: 16pt; text-align: left; } .report-table { width: 100%; font-size: 9pt; border-collapse: collapse; margin-top: 0; } .report-table th, .report-table td { border: 1px solid #666 !important; padding: 4px 6px !important; word-break: break-word; } .report-table th { background-color: #e0e0e0 !important; position: static !important; font-weight: bold; -webkit-print-color-adjust: exact; color-adjust: exact; } .report-table tr:nth-child(even) { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; color-adjust: exact; } .report-status-correct, .report-status-incorrect { font-weight: normal; -webkit-print-color-adjust: exact; color-adjust: exact; } .close-btn, .report-controls, .watermark, .teacher-view, .student-view > h1, .letter-tiles, .drop-zone, .smb-button, .form-group button#homeBtnSMB, .form-group button#resetSessionDataBtnSMB, .form-group button#adminDownloadAllDataBtnSMB { display: none !important; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="soundMatchingBoard" class="sound-matching-board">
        <div class="teacher-view">
            <div class="form-group">
                <label for="studentNameSMB">Student:</label>
                <input type="text" id="studentNameSMB">
            </div>
            <div class="form-group">
                <label for="adultNameSMB">Adult:</label>
                <input type="text" id="adultNameSMB">
            </div>
            <div class="form-group">
                <label for="testableSoundInputSMB">Testable Sound:</label>
                <input type="text" id="testableSoundInputSMB">
            </div>
            <div class="form-group">
                <label for="distractorSoundsInputSMB">Distractor Sounds (comma-separated):</label>
                <input type="text" id="distractorSoundsInputSMB" placeholder="e.g., m, s, t">
            </div>
            <div class="form-group">
                <label for="verbalSupportLevelSMB">Verbal Support Scale (1-5):</label>
                <div class="support-dropdown">
                    <select id="verbalSupportLevelSMB" class="support-select">
                        <option value="5" title="Continuous and explicit verbal instructions, repeated modeling, and detailed prompting required.">5 - Full Verbal Support</option>
                        <option value="4" title="Frequent, detailed verbal prompts and explicit modeling required.">4 - Significant Verbal Support</option>
                        <option value="3" title="Regular verbal cues, reminders, or partial modeling needed.">3 - Moderate Verbal Support</option>
                        <option value="2" title="Brief verbal prompts or minimal reminders needed occasionally.">2 - Minimal Verbal Support</option>
                        <option value="1" selected title="No verbal support required; student independent.">1 - Independent (Verbal)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="visualSupportLevelSMB">Visual Support Scale (1-5):</label>
                <div class="support-dropdown">
                    <select id="visualSupportLevelSMB" class="support-select">
                        <option value="5" title="Constant visual prompts (e.g., pointing, gesture, explicit visual aids, or repeated modeling) required.">5 - Full Visual Support</option>
                        <option value="4" title="Frequent visual cues or consistent modeling necessary.">4 - Significant Visual Support</option>
                        <option value="3" title="Occasional visual prompts (such as gestures, pointing, or visual aids) needed.">3 - Moderate Visual Support</option>
                        <option value="2" title="Rare or brief visual prompts required; student largely independent visually.">2 - Minimal Visual Support</option>
                        <option value="1" selected title="No visual support required; student independent.">1 - Independent (Visual)</option>
                    </select>
                </div>
            </div>
            <div class="form-group"><button id="generateBtnSMB" class="smb-button">Generate</button></div>
            <div class="form-group"><button id="resetBtnSMB" class="smb-button">Reset Tiles</button></div>
            <div class="form-group"><button id="correctBtnSMB" class="smb-button">Correct</button></div>
            <div class="form-group"><button id="incorrectBtnSMB" class="smb-button">Incorrect</button></div>
            <div class="form-group"><button id="reportBtnSMB" class="smb-button">View Report</button></div>
            <div class="form-group"><button id="printBtnSMB" class="smb-button">Print</button></div>
            <div class="form-group"><button id="resetSessionDataBtnSMB" class="smb-button">Reset Session Data</button></div>
            <div class="form-group"><button id="adminDownloadAllDataBtnSMB" class="smb-button">Download All Stored Data (Admin)</button></div>
            <div class="form-group"><button id="homeBtnSMB" class="smb-button">Clear Current Board</button></div>
        </div>
        <div class="student-view">
            <h1>M5 Sound Matching Board</h1>
            <div class="letter-tiles" id="soundTilesSMB"></div> <!-- Renamed ID -->
            <div class="drop-zone" id="dropZoneSMB">Drag the correct sound here!</div> <!-- Renamed ID -->
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="report-header">
                <h2>Sound Matching Progress Report</h2>
                <span class="close-btn" onclick="closeReportModal()">Ã—</span>
            </div>
            <div id="reportContent"></div>
            <div class="report-controls">
                <button class="report-btn export-csv-btn" onclick="exportReportCSVSMB(false)">Export Current View CSV</button>
                <button class="report-btn print-report-btn" onclick="printReportSMB()">Print Report</button>
                <button class="report-btn copy-report-btn" onclick="copyReportTextSMB()">Copy Report Text</button>
            </div>
        </div>
    </div>

    <div class="watermark">Scott Clee dev Â©</div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // START OF FIREBASE INITIALIZATION (Same as Blending Board)
        const firebaseConfig = {
            apiKey: "AIzaSyDwNqSt2UD1r0EO2CytEtqOmDiBxNIJM",
            authDomain: "m5-literacy-db.firebaseapp.com",
            projectId: "m5-literacy-db",
            storageBucket: "m5-literacy-db.firebasestorage.app",
            messagingSenderId: "389680220222",
            appId: "1:389680220222:web:623db2ed40f30a5ad3696f",
            measurementId: "G-PMLHCJ18F0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // END OF FIREBASE INITIALIZATION

        // Firestore Collection Reference for Sound Matching Board
        const soundMatchingProgressCollectionRef = db.collection("m5SoundMatching_progressData");

        // Sound data from speed_sounds.html (for reference or future features)
        const soundSetsData = [
            { name: "Set 1", sounds: ["a", "e", "i", "o", "u", "m", "s", "d", "t", "n", "p", "g", "c", "k", "b", "f", "l", "h", "r", "j", "v", "y", "w", "z", "x", "sh", "th", "ch", "qu", "ng", "nk"] },
            { name: "Set 2", sounds: ["ay", "ee", "igh", "ow", "oo", "oo", "ar", "or", "air", "ir", "ou", "oy"] },
            { name: "Set 3", sounds: ["ea", "oi", "a-e", "i-e", "o-e", "u-e", "aw", "are", "ur", "er", "ow", "ai", "oa", "ew", "ire", "ear", "ure", "tion", "tious/cious"] }
        ];

        const reportModalSMB = document.getElementById('reportModal'); // Re-use modal structure
        let currentTestableSoundSMB = '';
        let allSoundsPresentedSMB = []; // To store the array of sounds (testable + distractors)
        let chosenSoundSMB = null; // To store the sound dragged to the drop zone
        let progressDataSMB = [];
        let currentWordHasResultSMB = false; // Not strictly 'word' but 'attempt'
        let touchElementSMB = null;
        let touchStartXSMB = 0, touchStartYSMB = 0;
        let cloneElementSMB = null;
        let selectedTileSMB = null;
        let soundMatchingBoardInitialized = false;
        let currentAttemptIdSMB = null;

        async function initializeSoundMatchingBoard() {
            if (soundMatchingBoardInitialized) return;
            document.getElementById('generateBtnSMB').onclick = generateSoundsSMB;
            document.getElementById('resetBtnSMB').onclick = resetCurrentAttemptTilesSMB;
            document.getElementById('correctBtnSMB').onclick = () => markAccuracySMB(true);
            document.getElementById('incorrectBtnSMB').onclick = () => markAccuracySMB(false);
            document.getElementById('reportBtnSMB').onclick = showReportModalSMB;
            document.getElementById('printBtnSMB').onclick = printCurrentViewSMB;
            document.getElementById('resetSessionDataBtnSMB').onclick = handleResetSessionDataSMB;
            document.getElementById('adminDownloadAllDataBtnSMB').onclick = handleAdminDownloadAllDataSMB;
            document.getElementById('homeBtnSMB').onclick = clearSoundMatchingBoardInterface;

            const dropZone = document.getElementById('dropZoneSMB');
            dropZone.ondrop = (e) => dropTileSMB(e);
            dropZone.ondragover = allowDropSMB;
            dropZone.ontouchstart = (e) => { e.preventDefault(); handleDropZoneTouchSMB(e); };
            
            adjustDropZoneWidthSMB('dropZoneSMB', 1); // Set drop zone for 1 tile

            await loadProgressDataSMB();
            soundMatchingBoardInitialized = true;
            console.log("M5 Sound Matching Board Initialized and progress data loaded.");
        }

        function generateSoundsSMB() {
            const testableSoundInput = document.getElementById('testableSoundInputSMB').value.toLowerCase().trim();
            const distractorSoundsInput = document.getElementById('distractorSoundsInputSMB').value.toLowerCase().trim();

            if (!testableSoundInput) {
                alert("Please enter a testable sound.");
                return;
            }

            let soundsForTiles = [testableSoundInput];
            if (distractorSoundsInput) {
                const distractors = distractorSoundsInput.split(',').map(s => s.trim()).filter(s => s !== '');
                soundsForTiles.push(...distractors);
            }
            
            // Remove duplicates, keeping the first occurrence (which would be the testable sound if it was also in distractors)
            soundsForTiles = [...new Set(soundsForTiles)];


            if (soundsForTiles.length === 0) {
                 alert("No sounds to generate. Please enter a testable sound.");
                 return;
            }
            
            currentAttemptIdSMB = `attemptSMB-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
            currentTestableSoundSMB = testableSoundInput;
            allSoundsPresentedSMB = [...soundsForTiles]; // Store for logging
            currentWordHasResultSMB = false;
            chosenSoundSMB = null;

            // Shuffle soundsForTiles
            for (let i = soundsForTiles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [soundsForTiles[i], soundsForTiles[j]] = [soundsForTiles[j], soundsForTiles[i]];
            }

            const tilesDiv = document.getElementById('soundTilesSMB');
            tilesDiv.innerHTML = '';
            let tileCounter = 0;
            soundsForTiles.forEach(sound => {
                const tile = document.createElement('div');
                tile.className = 'letter-tile'; // Re-use class for styling
                tile.draggable = true;
                tile.textContent = sound;
                tile.id = `tile-smb-${currentAttemptIdSMB}-${tileCounter++}`;
                tile.ondragstart = (e) => dragTileStartSMB(e);
                tile.addEventListener('touchstart', (e) => handleTileTouchStartSMB(e), { passive: false });
                tile.addEventListener('touchmove', (e) => handleTileTouchMoveSMB(e), { passive: false });
                tile.addEventListener('touchend', (e) => handleTileTouchEndSMB(e), { passive: false });
                tilesDiv.appendChild(tile);
            });

            const dropZone = document.getElementById('dropZoneSMB');
            dropZone.innerHTML = 'Drag the correct sound here!';
            dropZone.classList.remove('correct', 'incorrect');
            if (selectedTileSMB) selectedTileSMB.classList.remove('selected');
            selectedTileSMB = null;
            
            adjustDropZoneWidthSMB('dropZoneSMB', 1); // Ensure drop zone sized for 1 tile
        }
        
        function adjustDropZoneWidthSMB(dropZoneId, numSlots = 1) { // numSlots is usually 1 for SMB
            const dropZone = document.getElementById(dropZoneId);
            if (!dropZone) return;

            // Get a sample tile to measure (or create a dummy one if none exist yet)
            let sampleTile = document.querySelector('.letter-tile');
            let tempAppend = false;
            if (!sampleTile) {
                sampleTile = document.createElement('div');
                sampleTile.className = 'letter-tile';
                sampleTile.style.visibility = 'hidden'; // Don't show it
                document.body.appendChild(sampleTile);
                tempAppend = true;
            }
            
            const tileStyle = window.getComputedStyle(sampleTile);
            const baseTileWidth = parseFloat(tileStyle.width) || 160; // Default if parsing fails
            
            if (tempAppend) {
                sampleTile.remove();
            }

            const gap = 10; // Gap between tiles if more than one slot (not typical for SMB dropzone)
            const paddingLR = (parseFloat(window.getComputedStyle(dropZone).paddingLeft) || 0) + 
                              (parseFloat(window.getComputedStyle(dropZone).paddingRight) || 0) || 40;
            
            let requiredWidth = (numSlots * baseTileWidth) + (Math.max(0, numSlots - 1) * gap) + paddingLR;
            
            const minWidthCSS = parseFloat(window.getComputedStyle(dropZone).minWidth) || 0;
            dropZone.style.width = `${Math.max(requiredWidth, minWidthCSS)}px`;
        }


        function resetCurrentAttemptTilesSMB() {
            const tilesDiv = document.getElementById('soundTilesSMB');
            const dropZone = document.getElementById('dropZoneSMB');
            
            // Clear existing tiles from drop zone and sound area
            tilesDiv.innerHTML = '';
            dropZone.innerHTML = 'Drag the correct sound here!';
            dropZone.classList.remove('correct', 'incorrect');
            chosenSoundSMB = null;
            currentWordHasResultSMB = false; // An attempt is active but no result yet
            if (selectedTileSMB) selectedTileSMB.classList.remove('selected');
            selectedTileSMB = null;

            // If there was a set of sounds presented, re-generate them (shuffled)
            if (currentTestableSoundSMB && allSoundsPresentedSMB.length > 0 && currentAttemptIdSMB) {
                let soundsToRegenerate = [...allSoundsPresentedSMB];
                // Re-shuffle
                for (let i = soundsToRegenerate.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [soundsToRegenerate[i], soundsToRegenerate[j]] = [soundsToRegenerate[j], soundsToRegenerate[i]];
                }

                let tileCounter = 0;
                soundsToRegenerate.forEach(sound => {
                    const tile = document.createElement('div');
                    tile.className = 'letter-tile';
                    tile.draggable = true;
                    tile.textContent = sound;
                    tile.id = `tile-smb-${currentAttemptIdSMB}-${tileCounter++}-reset`; // Ensure unique ID on reset
                    tile.ondragstart = (e) => dragTileStartSMB(e);
                    tile.addEventListener('touchstart', (e) => handleTileTouchStartSMB(e), { passive: false });
                    tile.addEventListener('touchmove', (e) => handleTileTouchMoveSMB(e), { passive: false });
                    tile.addEventListener('touchend', (e) => handleTileTouchEndSMB(e), { passive: false });
                    tilesDiv.appendChild(tile);
                });
            } else {
                 // If no current attempt, just ensure drop zone is reset visually
                 adjustDropZoneWidthSMB('dropZoneSMB', 1);
            }
        }

        function clearSoundMatchingBoardInterface() {
            document.getElementById('studentNameSMB').value = '';
            document.getElementById('adultNameSMB').value = '';
            document.getElementById('testableSoundInputSMB').value = '';
            document.getElementById('distractorSoundsInputSMB').value = '';
            document.getElementById('soundTilesSMB').innerHTML = '';
            const dropZone = document.getElementById('dropZoneSMB');
            dropZone.innerHTML = 'Drag the correct sound here!';
            dropZone.classList.remove('correct', 'incorrect');
            
            currentTestableSoundSMB = '';
            allSoundsPresentedSMB = [];
            chosenSoundSMB = null;
            currentAttemptIdSMB = null;
            currentWordHasResultSMB = false;
            if (selectedTileSMB) selectedTileSMB.classList.remove('selected');
            selectedTileSMB = null;
            document.getElementById('verbalSupportLevelSMB').value = '1';
            document.getElementById('visualSupportLevelSMB').value = '1';
            adjustDropZoneWidthSMB('dropZoneSMB', 1); 
            console.log("Sound Matching Board interface cleared.");
        }

        async function markAccuracySMB(isCorrectByTeacher) {
            if (!currentAttemptIdSMB || !currentTestableSoundSMB) {
                alert("Please generate sounds first before marking correct/incorrect.");
                return;
            }
            if (!chosenSoundSMB) {
                alert("Please have the student drag a sound to the drop zone before marking.");
                return;
            }

            const dropZone = document.getElementById('dropZoneSMB');
            dropZone.classList.toggle('correct', isCorrectByTeacher);
            dropZone.classList.toggle('incorrect', !isCorrectByTeacher);
            currentWordHasResultSMB = true; // Mark attempt as having a result
            if (isCorrectByTeacher) launchConfetti(); // Confetti for teacher-marked correct

            await saveProgressSMB(isCorrectByTeacher, currentTestableSoundSMB, chosenSoundSMB, allSoundsPresentedSMB, currentAttemptIdSMB);
        }

        function allowDropSMB(ev) { ev.preventDefault(); }

        function dragTileStartSMB(ev) {
            ev.dataTransfer.setData("text", ev.target.textContent);
            ev.dataTransfer.setData("id", ev.target.id);
            // No viewType needed as it's a single-view app type
        }

        function dropTileSMB(ev) {
            ev.preventDefault(); ev.stopPropagation();
            let soundValue, tileId, sourceElement = null;

            // Determine source of drop: drag event or touch selection
            if (ev.dataTransfer && ev.dataTransfer.types.length > 0 && ev.dataTransfer.types.includes("id")) {
                soundValue = ev.dataTransfer.getData("text");
                tileId = ev.dataTransfer.getData("id");
                sourceElement = document.getElementById(tileId);
            } else if (selectedTileSMB) {
                soundValue = selectedTileSMB.textContent;
                tileId = selectedTileSMB.id;
                sourceElement = selectedTileSMB;
            } else if (touchElementSMB) { // From a direct touch-drag-release
                soundValue = touchElementSMB.textContent;
                tileId = touchElementSMB.id;
                sourceElement = touchElementSMB;
            } else {
                console.warn("Drop event with no clear data source."); return;
            }

            if (!soundValue || !tileId) { console.error("Could not determine sound or tileId for drop."); return; }

            const dropZone = document.getElementById('dropZoneSMB');
            dropZone.innerHTML = ''; // Clear previous tile in drop zone

            const newTileInDropZone = document.createElement('div');
            newTileInDropZone.className = 'letter-tile'; // Use same styling
            newTileInDropZone.textContent = soundValue;
            newTileInDropZone.setAttribute('data-original-id', tileId); // Keep track of original tile
            dropZone.appendChild(newTileInDropZone);
            
            chosenSoundSMB = soundValue; // Store the chosen sound

            // Auto-check for immediate visual feedback (teacher buttons are final)
            if (currentTestableSoundSMB && soundValue.toLowerCase() === currentTestableSoundSMB.toLowerCase()) {
                dropZone.classList.add('correct');
                dropZone.classList.remove('incorrect');
            } else {
                dropZone.classList.add('incorrect');
                dropZone.classList.remove('correct');
            }

            // Remove the tile from the source pile
            if (sourceElement && sourceElement.parentNode) {
                sourceElement.remove();
            }
            
            // Clean up touch/selection states
            if (cloneElementSMB) cloneElementSMB.remove();
            cloneElementSMB = null;
            if (selectedTileSMB) selectedTileSMB.classList.remove('selected');
            selectedTileSMB = null;
            touchElementSMB = null;
        }
        
        function handleTileTouchStartSMB(ev) {
            ev.preventDefault(); ev.stopPropagation();
            const tile = ev.target.closest('.letter-tile');
            if (!tile || !tile.parentElement || tile.parentElement.id !== 'soundTilesSMB') {
                 if (selectedTileSMB) selectedTileSMB.classList.remove('selected'); selectedTileSMB = null; return;
            }
            if (selectedTileSMB === tile) { // Tapping an already selected tile (to deselect or prepare for drop zone tap)
                // Keep it selected for potential drop zone tap
                // Or deselect if user means to cancel: for now, let's assume they might tap dropzone next
            } else if (selectedTileSMB) { // Selecting a new tile
                selectedTileSMB.classList.remove('selected');
                if (cloneElementSMB) cloneElementSMB.remove(); cloneElementSMB = null;
            }
            selectedTileSMB = tile; selectedTileSMB.classList.add('selected'); touchElementSMB = tile;
            const touch = ev.changedTouches[0]; touchStartXSMB = touch.clientX; touchStartYSMB = touch.clientY;
            
            let newClone = tile.cloneNode(true);
            Object.assign(newClone.style, { position: 'absolute', opacity: '0.7', zIndex: '10000', pointerEvents: 'none' });
            const rect = tile.getBoundingClientRect();
            Object.assign(newClone.style, { left: `${rect.left}px`, top: `${rect.top}px`, width: `${rect.width}px`, height: `${rect.height}px` });
            document.body.appendChild(newClone); cloneElementSMB = newClone;
        }

        function handleTileTouchMoveSMB(ev) {
            ev.preventDefault(); ev.stopPropagation();
            if (!cloneElementSMB || !touchElementSMB) return;
            const touch = ev.changedTouches[0];
            cloneElementSMB.style.left = `${touch.clientX - (cloneElementSMB.offsetWidth / 2)}px`;
            cloneElementSMB.style.top = `${touch.clientY - (cloneElementSMB.offsetHeight / 2)}px`;
        }

        function handleTileTouchEndSMB(ev) {
            ev.preventDefault(); ev.stopPropagation();
            if (!touchElementSMB || !cloneElementSMB) {
                if(cloneElementSMB) cloneElementSMB.remove(); cloneElementSMB = null; touchElementSMB = null; return;
            }
            const touch = ev.changedTouches[0]; const dropZone = document.getElementById('dropZoneSMB');
            cloneElementSMB.style.visibility = 'hidden'; // Check element underneath without clone obscuring
            const elementUnderneath = document.elementFromPoint(touch.clientX, touch.clientY);
            cloneElementSMB.style.visibility = 'visible';

            if (elementUnderneath && (elementUnderneath === dropZone || dropZone.contains(elementUnderneath))) {
                // Ensure selectedTileSMB is the one being touched if it wasn't already
                if (selectedTileSMB !== touchElementSMB && touchElementSMB.classList.contains('letter-tile')) {
                    if(selectedTileSMB) selectedTileSMB.classList.remove('selected');
                    selectedTileSMB = touchElementSMB; selectedTileSMB.classList.add('selected');
                }
                dropTileSMB(ev); // Pass event to dropTileSMB
            } else {
                // If not dropped on drop zone, and it was the selected tile, deselect it
                if (selectedTileSMB === touchElementSMB) { 
                    selectedTileSMB.classList.remove('selected');
                    selectedTileSMB = null;
                }
            }
            cloneElementSMB.remove(); cloneElementSMB = null; touchElementSMB = null;
        }

        function handleDropZoneTouchSMB(ev) {
            ev.stopPropagation(); // Prevent triggering other touch events
            if (selectedTileSMB && selectedTileSMB.parentElement && selectedTileSMB.parentElement.id === 'soundTilesSMB') {
                // A tile is selected from the sound bank, and drop zone was tapped
                dropTileSMB(ev); // Process the drop
            } else if (selectedTileSMB) {
                // A tile might be selected but not from the sound bank (e.g. already in drop zone - not typical here)
                // Or just deselect if no valid source
                selectedTileSMB.classList.remove('selected');
                selectedTileSMB = null;
            }
        }

        async function saveProgressSMB(isCorrect, testableSound, chosenSnd, allSounds, attemptId) {
            const studentName = document.getElementById('studentNameSMB').value.trim();
            const adultName = document.getElementById('adultNameSMB').value.trim();
            const verbalSupportSelect = document.getElementById('verbalSupportLevelSMB');
            const visualSupportSelect = document.getElementById('visualSupportLevelSMB');

            if (!attemptId) {
                alert("Error: Cannot save progress without an active attempt ID. Please generate sounds first.");
                return false;
            }

            const entryData = {
                studentName: studentName || "N/A",
                adultName: adultName || "N/A",
                testableSound: testableSound,
                chosenSound: chosenSnd || "N/A", // The sound student selected
                allSoundsPresented: allSounds || [], // All sounds shown as options
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                verbalSupportLevel: verbalSupportSelect.value,
                verbalSupportDescription: verbalSupportSelect.options[verbalSupportSelect.selectedIndex].text,
                visualSupportLevel: visualSupportSelect.value,
                visualSupportDescription: visualSupportSelect.options[visualSupportSelect.selectedIndex].text,
                accuracy: isCorrect,
                sourceView: "SMB", // Sound Matching Board
                originalAttemptId: attemptId
            };

            try {
                await soundMatchingProgressCollectionRef.doc(attemptId).set(entryData);
                console.log("Sound Matching progress saved to Firestore for attemptId:", attemptId);
                return true;
            } catch (e) {
                console.error("Error saving Sound Matching progress to Firestore:", e);
                alert("Error saving Sound Matching progress. Check console for errors.");
                return false;
            }
        }

        async function loadProgressDataSMB() {
            console.log("Attempting to load Sound Matching progress data from Firestore...");
            try {
                const querySnapshot = await soundMatchingProgressCollectionRef.orderBy("timestamp", "desc").get();
                progressDataSMB = [];
                querySnapshot.forEach((doc) => {
                    let data = doc.data();
                    if (data.timestamp && data.timestamp.toDate) {
                        data.timestamp = data.timestamp.toDate().toISOString();
                    }
                    progressDataSMB.push({ firestoreDocId: doc.id, ...data });
                });
                console.log("Sound Matching progress data loaded. Count:", progressDataSMB.length);
            } catch (error) {
                console.error("Error loading Sound Matching progress data: ", error);
                alert("Could not load Sound Matching progress data. Check console for errors.");
                progressDataSMB = [];
            }
        }

        async function handleResetSessionDataSMB() {
            const password = prompt("To reset all Sound Matching session data, enter password:", "");
            if (password === "1234") { // Simple password, consider .env for real app
                try {
                    const progressSnapshot = await soundMatchingProgressCollectionRef.get();
                    const batch = db.batch();
                    progressSnapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                    await batch.commit();
                    console.log("All Sound Matching session data deleted from Firestore.");
                    progressDataSMB = [];
                    clearSoundMatchingBoardInterface();
                    alert("All Sound Matching session data reset from the database.");
                    closeReportModal();
                } catch (error) {
                    console.error("Error resetting Sound Matching session data: ", error);
                    alert("Error resetting Sound Matching data. Check console for errors.");
                }
            } else if (password !== null) {
                alert("Incorrect password.");
            }
        }

        async function handleAdminDownloadAllDataSMB() {
            const password = prompt("To download all Sound Matching data, enter admin password:", "");
            if (password === "1234") {
                await loadProgressDataSMB(); // Load fresh data
                exportReportCSVSMB(true); // Export all data
            } else if (password !== null) {
                alert("Incorrect admin password.");
            }
        }

        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function generateReportTextSMB() {
            if (progressDataSMB.length === 0) return "No Sound Matching progress data available.";
            let reportText = "M5 Sound Matching Progress Report\n\n" +
                             "# | Student | Adult | Testable Sound | Chosen Sound | Date & Time | Verbal Support | Visual Support | Result\n" +
                             Array(160).join("-") + "\n"; // Adjusted line length
            progressDataSMB.forEach((entry, index) => {
                reportText += `${String(index + 1).padEnd(2)} | ` +
                              `${String(entry.studentName).padEnd(15)} | ` +
                              `${String(entry.adultName).padEnd(10)} | ` +
                              `${String(entry.testableSound).padEnd(15)} | ` +
                              `${String(entry.chosenSound).padEnd(12)} | ` +
                              `${formatDate(entry.timestamp).padEnd(22)} | ` +
                              `${entry.verbalSupportDescription.padEnd(30)} | ` +
                              `${entry.visualSupportDescription.padEnd(30)} | ` +
                              `${(entry.accuracy ? 'Correct' : 'Incorrect')}\n`;
            });
            return reportText;
        }
        
        function copyReportTextSMB() {
            const reportText = generateReportTextSMB();
            if (reportText.startsWith("No")) { alert(reportText); return; }
            copyToClipboard(reportText, "Sound Matching report text copied.");
        }

        // Generic copyToClipboard (shared utility)
        function copyToClipboard(text, message = 'Copied!') {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => alert(message))
                    .catch(err => { fallbackCopyToClipboard(text, message); });
            } else { fallbackCopyToClipboard(text, message); }
        }
        function fallbackCopyToClipboard(text, message) {
            const ta = document.createElement('textarea');
            ta.value = text;
            Object.assign(ta.style, { position: 'fixed', top: '0', left: '0', opacity: '0' });
            document.body.appendChild(ta);
            ta.select();
            try {
                if (document.execCommand('copy')) alert(message); else alert('Fallback copy failed.');
            } catch (err) { alert('Fallback copy error.'); }
            document.body.removeChild(ta);
        }

        async function showReportModalSMB() {
            await loadProgressDataSMB();
            const rc = document.getElementById('reportContent'); rc.innerHTML = '';
            if (progressDataSMB.length === 0) {
                rc.innerHTML = '<p class="no-data-message">No Sound Matching data to report.</p>';
            } else {
                let tableHTML = `<table class="report-table"><thead><tr>` +
                                `<th>#</th><th>Student</th><th>Adult</th><th>Testable Sound</th><th>Chosen Sound</th>` +
                                `<th>Date</th><th>Verbal</th><th>Visual</th><th>Result</th>` +
                                `</tr></thead><tbody>`;
                progressDataSMB.forEach((e, i) => {
                    tableHTML += `<tr><td>${i+1}</td>` +
                                 `<td>${e.studentName}</td><td>${e.adultName}</td>` +
                                 `<td>${e.testableSound}</td><td>${e.chosenSound}</td>` +
                                 `<td class="formatted-date">${formatDate(e.timestamp)}</td>` +
                                 `<td>${e.verbalSupportDescription}</td><td>${e.visualSupportDescription}</td>` +
                                 `<td class="${e.accuracy?'report-status-correct':'report-status-incorrect'}">${e.accuracy?'Correct':'Incorrect'}</td></tr>`;
                });
                tableHTML += `</tbody></table>`; rc.innerHTML = tableHTML;
            }
            reportModalSMB.style.display = 'block';
        }

        function closeReportModal() { // Generic, used by HTML onclick
             const modalToClose = document.getElementById('reportModal');
             if(modalToClose) modalToClose.style.display = 'none';
        }

        function exportReportCSVSMB(isMasterLog = false) {
            if (progressDataSMB.length === 0) { alert('No Sound Matching data to export.'); return; }
            const fmt = (f) => `"${String(f==null?'':f).replace(/"/g,'""')}"`;
            let csv = '';
            const hdrs = isMasterLog
                ? ['#','Student','Adult','Testable Sound','Chosen Sound','All Sounds Presented','Date','Verbal Support','Visual Support','Result','Attempt ID (JS)', 'Firestore Doc ID']
                : ['#','Student','Adult','Testable Sound','Chosen Sound','Date','Verbal Support','Visual Support','Result'];
            csv += hdrs.map(fmt).join(',') + '\n';
            
            progressDataSMB.forEach((e, i) => {
                let r = [i+1, e.studentName, e.adultName, e.testableSound, e.chosenSound];
                if(isMasterLog) {
                    r.push(Array.isArray(e.allSoundsPresented) ? e.allSoundsPresented.join('; ') : ''); // Join array for CSV
                }
                r.push(formatDate(e.timestamp), e.verbalSupportDescription, e.visualSupportDescription, (e.accuracy?'Correct':'Incorrect'));
                if(isMasterLog){
                    r.push(e.originalAttemptId || 'N/A');
                    r.push(e.firestoreDocId || 'N/A');
                }
                csv+=r.map(fmt).join(',')+'\n';
            });
            const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
            const link=document.createElement('a');
            const fn=isMasterLog?'m5_sound_matching_master_log.csv':'m5_sound_matching_report.csv';
            if(navigator.msSaveBlob){navigator.msSaveBlob(blob,fn);}
            else{
                const url=URL.createObjectURL(blob);
                link.href=url;link.download=fn;
                document.body.appendChild(link);link.click();
                document.body.removeChild(link);URL.revokeObjectURL(url);
            }
        }
        
        function printReportSMB() { // Called from modal button
            window.print();
        }
        function printCurrentViewSMB() { // Called from main teacher panel button
            showReportModalSMB(); 
            setTimeout(window.print, 300); // Allow modal to render
        }

        function launchConfetti() { // Same confetti function
            const cont = document.body;
            for(let i=0;i<60;i++){
                const p=document.createElement('div');
                const size = Math.random()*10+5;
                p.style.cssText=`position:fixed;left:${Math.random()*100}vw;top:${Math.random()*-60+0}vh;width:${size}px;height:${size}px;background:hsl(${Math.random()*360},100%,60%);opacity:.9;z-index:10001;border-radius:${Math.random()>0.5?'50%':'0'};transform:rotate(${Math.random()*360}deg);`;
                cont.appendChild(p);
                p.animate([
                    {transform:`translateY(0) rotate(${Math.random()*360}deg)`,opacity:1},
                    {transform:`translateY(130vh) rotate(${Math.random()*1000+360}deg)`,opacity:0}
                ],{duration:Math.random()*2500+3500,easing:'cubic-bezier(0.1,0.5,0.5,1)',delay:Math.random()*300,iterations:1,fill:'forwards'});
                setTimeout(()=>p.remove(),6500);
            }
        }

        async function initializeAppSMB() {
            await initializeSoundMatchingBoard();
        }
        initializeAppSMB();

    </script>
</body>
</html>